name: Docker ê¸°ë°˜ Spring Boot ì•± ë°°í¬

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-and-push:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest

    steps:
      - name: GitHub ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Gradle Wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ í¬í•¨)
        run: ./gradlew build
        env:
          KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{secrets.DB_NAME}}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          KAKAO_REDIRECT_URI: ${{ secrets.KAKAO_REDIRECT_URI }}

      - name: DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/swyp10-9-backend:latest

  deploy-to-server:
    name: ì„œë²„ì— ë°°í¬
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: SSH ì ‘ì† ë° Docker ì§ì ‘ ì‹¤í–‰
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            echo "ğŸ“¦ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ"
            docker stop swyp10-9-backend || true
            docker rm swyp10-9-backend || true
            
            echo "ğŸ—‘ï¸ ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ"
            docker rmi ${{ secrets.DOCKER_USERNAME }}/swyp10-9-backend:latest || true
            
            echo "ğŸ“¥ ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ"
            docker pull ${{ secrets.DOCKER_USERNAME }}/swyp10-9-backend:latest
            
            echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
            docker run -d \
              --name swyp10-9-backend \
              --restart unless-stopped \
              -p 8080:8080 \
              -e KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}" \
              -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              -e DB_NAME="${{secrets.DB_NAME}}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e KAKAO_REDIRECT_URI="${{ secrets.KAKAO_REDIRECT_URI }}" \
              ${{ secrets.DOCKER_USERNAME }}/swyp10-9-backend:latest
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            docker ps | grep swyp10-9-backend